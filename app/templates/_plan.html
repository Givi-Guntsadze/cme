<section class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
    <h2 style="margin:0;">Recommended Plan</h2>
    <button
      hx-post="/ingest"
      hx-swap="none"
      hx-on::before-request="this.dataset.originalText=this.textContent; this.disabled=true; this.textContent='Discovering…';"
      hx-on::after-request="(function(btn, evt){ if(btn.dataset){ btn.textContent=btn.dataset.originalText||'Discover'; btn.disabled=false; } try { const xhr = evt.detail && evt.detail.xhr; if (xhr) { let data = {}; try { data = JSON.parse(xhr.responseText || '{}'); } catch (err) { data = {}; } if (typeof data.ingested !== 'undefined') { const params = new URLSearchParams(window.location.search); params.set('added', data.ingested || 0); if (typeof data.google_inserted !== 'undefined') { params.set('gcount', data.google_inserted || 0); } if (typeof data.ai_inserted !== 'undefined') { params.set('acount', data.ai_inserted || 0); } params.set('fallback', data.used_fallback ? '1' : '0'); history.replaceState(null, '', '?' + params.toString()); const banner = document.getElementById('ingest-banner'); if (banner) { banner.innerHTML = '<div class=\'card\' style=\'background:#f0fff4;border-left:4px solid #34d399;padding:8px 12px;margin:8px 0;\'>Imported ' + (data.ingested || 0) + ' new activities — Web: ' + (data.google_inserted || 0) + ', AI: ' + (data.ai_inserted || 0) + (data.used_fallback ? ' (fallback used)' : '') + '.</div>'; } const planRoot = document.getElementById('plan-card'); if (planRoot && window.htmx) { window.htmx.trigger(document.body || window, 'plan-refresh'); } return; } if (data.error) { const banner = document.getElementById('ingest-banner'); if (banner) { banner.innerHTML = '<div class=\'card\' style=\'background:#fff7f7;border-left:4px solid #f87171;padding:8px 12px;margin:8px 0;\'>' + data.error + '</div>'; } return; } } } catch (err) { console.error(err); } })(this, event);"
      class="button"
      type="button"
    >Discover</button>
  </div>
  <p class="meta" style="margin-top: -4px;">Balanced plan shown. Ask if you'd like more discovery or a cheaper mix.</p>
  {% if plan_summary %}
    <div class="meta plan-summary">
      {{ plan_summary.item_count }} {{ 'activity' if plan_summary.item_count == 1 else 'activities' }}
      • {{ '%.1f' % plan_summary.total_credits }} cr
      • {{ plan_summary.cost_display }}
      {% if plan_summary.days_used %}
        • {{ plan_summary.days_used }} days off
      {% endif %}
    </div>
    <div class="plan-global-actions">
      <button
        type="button"
        class="button"
        hx-post="/plan/accept_all"
        hx-target="#plan-card"
        hx-swap="innerHTML"
      >Accept Plan</button>
      <button
        type="button"
        class="button"
        hx-post="/plan/reject_all"
        hx-target="#plan-card"
        hx-swap="innerHTML"
      >Reject Plan</button>
    </div>
  {% endif %}
  {% if plan_requirements and plan_requirements.messages %}
    <div class="requirement-banner">
      <strong>Requirement focus:</strong> {{ plan_requirements.messages | join(' • ') }}
    </div>
  {% endif %}
  {% if plan and plan|length > 0 %}
    <ul class="plan">
      {% for p in plan %}
        <li>
          <div class="title">
            {% if p.url %}
              <a href="{{ p.url }}" target="_blank" rel="noopener noreferrer">{{ p.title }}</a>
            {% else %}
              {{ p.title }}
            {% endif %}
          </div>
          <div class="meta">
            {{ p.provider }} • {{ p.modality }}{% if p.city %} • {{ p.city }}{% endif %}
            {% if p.source_label %}
              <span class="badge" style="margin-left:8px; background:#eef;">{{ p.source_label }}</span>
            {% endif %}
            {% if p.topic and p.topic != 'general' %}
              <span class="badge topic">{{ p.topic.replace('_', ' ')|title }}</span>
            {% endif %}
            {% if p.hybrid_available %}
              <span class="badge" style="margin-left:8px; background:#e6fffa;">Hybrid</span>
            {% endif %}
            {% if p.eligibility_status == 'eligible' %}
              <span class="badge eligibility ok" title="{{ p.eligibility_text or 'Eligible for you' }}">✅ Eligible</span>
            {% elif p.eligibility_status in ['uncertain', 'ineligible'] %}
              <span class="badge eligibility warn" title="{{ p.eligibility_text or 'Eligibility may be restricted — please double check.' }}">⚠️ Check eligibility</span>
            {% endif %}
          </div>
          <div class="meta">
            {{ '%.1f' % p.credits }} cr • {{ p.cost_display }}
            {% if p.price_label %}
              <span class="badge" style="margin-left:8px; background:#fef3c7;">{{ p.price_label }}</span>
            {% endif %}
            {% if p.base_cost and p.base_cost != p.cost %}
              <span class="meta" style="margin-left:8px;">Std ${{ '%.0f' % p.base_cost }}</span>
            {% endif %}
          </div>
          {% if p.deadline_text %}
            <div class="meta" style="color:#b45309;">Register by {{ p.deadline_text }}{% if p.deadline_urgency %} ({{ p.deadline_urgency }}){% endif %}</div>
          {% endif %}
          {% if p.pricing_notes %}
            <div class="meta" style="color:#6b7280;">{{ p.pricing_notes }}</div>
          {% endif %}
          {% if p.summary %}
            <div class="meta">{{ p.summary }}</div>
          {% endif %}
          <div class="plan-actions">
            {% if p.committed %}
              <span class="badge committed">Accepted</span>
              <button
                type="button"
                class="linklike"
                hx-post="/plan/reject/{{ p.activity_id }}"
                hx-target="#plan-card"
                hx-swap="innerHTML"
                title="Remove this activity from the plan"
              >Remove</button>
              <button
                type="button"
                class="linklike"
                hx-post="/plan/reject_with_substitute/{{ p.activity_id }}"
                hx-target="#plan-card"
                hx-swap="innerHTML"
                title="Remove this activity and ask the assistant to find alternatives"
              >Remove &amp; find substitute</button>
            {% else %}
              <button
                type="button"
                class="linklike"
                hx-post="/plan/accept/{{ p.activity_id }}"
                hx-target="#plan-card"
                hx-swap="innerHTML"
                title="Accept this activity into your plan"
              >Accept</button>
              <button
                type="button"
                class="linklike"
                hx-post="/plan/reject/{{ p.activity_id }}"
                hx-target="#plan-card"
                hx-swap="innerHTML"
                title="Reject this suggestion"
              >Reject</button>
              <button
                type="button"
                class="linklike"
                hx-post="/plan/reject_with_substitute/{{ p.activity_id }}"
                hx-target="#plan-card"
                hx-swap="innerHTML"
                title="Reject and ask the assistant to find a substitute"
              >Reject &amp; find substitute</button>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="meta">You don't have a CME plan yet, let's fix that.</p>
  {% endif %}
</section>
