<section class="plan-card">
  <div id="plan-loading-indicator" class="plan-loading-overlay">
    <span class="plan-loading-text">üîç Searching for substitute...</span>
  </div>
  <div class="plan-card-header">
    <div>
      <h3>Recommended Plan</h3>
      <p class="plan-card-subtitle">
        {% if plan_summary %}
        Tailored to your profile and current requirement gaps.
        {% else %}
        Discover activities to start drafting your CME roadmap.
        {% endif %}
      </p>
    </div>
    <div class="plan-card-actions">
      <button type="button" class="btn-primary" hx-post="/ingest" hx-swap="none"
        hx-on::before-request="this.dataset.originalText=this.textContent; this.disabled=true; this.textContent='Discovering‚Ä¶';"
        hx-on::after-request="window.handleIngestResponse(this, event);">
        Discover activities
      </button>
      <button type="button" class="btn-secondary" hx-post="/reenrich" hx-swap="none"
        hx-on::before-request="this.dataset.originalText=this.textContent; this.disabled=true; this.textContent='Enriching‚Ä¶';"
        hx-on::after-request="window.handleReenrichResponse(this, event);">
        Enrich data
      </button>
      <a href="/catalog-page" class="btn-secondary">
        üìö Browse Catalog
      </a>
    </div>
  </div>
  {% if plan_summary %}
  <div class="plan-summary-row">
    <span class="summary-pill">
      {{ plan_summary.item_count }} {{ 'activity' if plan_summary.item_count == 1 else 'activities' }}
    </span>
    <span class="summary-pill">{{ '%.1f' % plan_summary.total_credits }} cr</span>
    <span class="summary-pill">{{ plan_summary.cost_display }}</span>
    {% if plan_summary.days_used %}
    <span class="summary-pill">{{ plan_summary.days_used }} days off</span>
    {% endif %}
  </div>
  <div class="plan-global-actions">
    <button type="button" class="btn-secondary" hx-post="/plan/accept_all" hx-target="#plan-card"
      hx-swap="innerHTML">Accept plan</button>
    <button type="button" class="btn-secondary" hx-post="/plan/reject_all" hx-target="#plan-card"
      hx-swap="innerHTML">Reject plan</button>
  </div>
  {% endif %}
  {% if plan_requirements and plan_requirements.messages %}
  <div class="plan-focus-banner">
    <strong>Requirement focus:</strong> {{ plan_requirements.messages | join(' ‚Ä¢ ') }}
  </div>
  {% endif %}
  {% if plan and plan|length > 0 %}
  <ul class="plan-items">
    {% for p in plan %}
    {% set icon_ns = namespace(text='C') %}
    {% if p.modality %}
    {% set icon_ns.text = p.modality[0]|upper %}
    {% endif %}
    <li
      class="plan-item{% if p.committed %} plan-item-committed{% endif %}{% if p.newly_added %} newly-added{% endif %}">
      <div class="plan-item-header">
        <div class="plan-item-info">
          <div class="plan-item-icon" aria-hidden="true">{{ icon_ns.text }}</div>
          <div class="plan-item-title-block">
            <h4>
              {% if p.url %}
              <a href="{{ p.url }}" target="_blank" rel="noopener noreferrer">{{ p.title }}</a>
              {% else %}
              {{ p.title }}
              {% endif %}
            </h4>
            <div class="plan-item-meta">
              {% if p.provider %}
              <span>{{ p.provider }}</span>
              {% endif %}
              {% if p.modality %}
              <span>{{ p.modality }}</span>
              {% endif %}
              {% if p.city %}
              <span>{{ p.city }}</span>
              {% endif %}
            </div>
            <div class="plan-item-badges">
              {% if p.source_label %}
              <span class="badge badge-source">{{ p.source_label }}</span>
              {% endif %}
              {% if p.topic and p.topic != 'general' %}
              <span class="badge badge-topic">{{ p.topic.replace('_', ' ')|title }}</span>
              {% endif %}
              {% if p.hybrid_available %}
              <span class="badge badge-hybrid">Hybrid</span>
              {% endif %}
              {% if p.eligibility_status == 'eligible' %}
              <span class="badge badge-eligibility ok"
                title="{{ p.eligibility_text or 'Eligible for you' }}">Eligible</span>
              {% elif p.eligibility_status in ['uncertain', 'ineligible'] %}
              <span class="badge badge-eligibility warn"
                title="{{ p.eligibility_text or 'Eligibility may be restricted ‚Äî please double check.' }}">Check
                eligibility</span>
              {% endif %}
              {% if p.price_label %}
              <span class="badge badge-price">{{ p.price_label }}</span>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="plan-item-stats">
          <span class="plan-item-credits">{{ '%.1f' % p.credits }} cr</span>
          <span class="plan-item-cost">{{ p.cost_display }}</span>
          {% if p.base_cost and p.base_cost != p.cost %}
          <span class="plan-item-base">Std ${{ '%.0f' % p.base_cost }}</span>
          {% endif %}
        </div>
      </div>
      {% if p.deadline_text or p.pricing_notes or p.summary %}
      <div class="plan-item-body">
        {% if p.deadline_text %}
        <div class="plan-item-deadline">Register by {{ p.deadline_text }}{% if p.deadline_urgency %} ({{
          p.deadline_urgency }}){% endif %}</div>
        {% endif %}
        {% if p.pricing_notes %}
        <div class="plan-item-note">{{ p.pricing_notes }}</div>
        {% endif %}
        {% if p.summary %}
        <div class="plan-item-summary">{{ p.summary }}</div>
        {% endif %}
      </div>
      {% endif %}
      <div class="plan-item-footer">
        {% if p.committed %}
        <span class="badge committed">Accepted</span>
        <div class="plan-item-actions">
          <button type="button" class="linklike" hx-post="/plan/reject/{{ p.activity_id }}" hx-target="#plan-card"
            hx-swap="innerHTML" title="Remove this activity from the plan">Remove</button>
          <button type="button" class="linklike substitute-btn"
            hx-post="/plan/reject_with_substitute/{{ p.activity_id }}" hx-target="#plan-card" hx-swap="innerHTML"
            hx-indicator="#plan-loading-indicator"
            title="Remove this activity and ask the assistant to find alternatives">Remove &amp; find
            substitute</button>
        </div>
        {% else %}
        <div class="plan-item-actions">
          <button type="button" class="linklike" hx-post="/plan/accept/{{ p.activity_id }}" hx-target="#plan-card"
            hx-swap="innerHTML" title="Accept this activity into your plan">Accept</button>
          <button type="button" class="linklike" hx-post="/plan/reject/{{ p.activity_id }}" hx-target="#plan-card"
            hx-swap="innerHTML" title="Reject this suggestion">Reject</button>
          <button type="button" class="linklike substitute-btn"
            hx-post="/plan/reject_with_substitute/{{ p.activity_id }}" hx-target="#plan-card" hx-swap="innerHTML"
            hx-indicator="#plan-loading-indicator" title="Reject and ask the assistant to find a substitute">Reject
            &amp; find substitute</button>
        </div>
        {% endif %}
      </div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="empty-state">You don't have a CME plan yet. Run discovery or ask the assistant to find options.</p>
  {% endif %}
</section>