<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CME AI Concierge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    (function () {
      var storageKey = "cme-theme";
      var storedTheme = null;
      try {
        storedTheme = window.localStorage.getItem(storageKey);
      } catch (err) {
        storedTheme = null;
      }
      var prefersDark = false;
      try {
        prefersDark =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
      } catch (err) {
        prefersDark = false;
      }
      var initialTheme = storedTheme || (prefersDark ? "dark" : "light");
      document.documentElement.setAttribute("data-theme", initialTheme);
      document.documentElement.classList.add("theme-" + initialTheme);
    })();
  </script>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>

<body>
  <main class="app-root">
    {% block content %}{% endblock %}
  </main>
  <script>
    (function () {
      var storageKey = "cme-theme";
      var current =
        document.documentElement.getAttribute("data-theme") || "light";
      function applyTheme(theme) {
        current = theme;
        document.documentElement.setAttribute("data-theme", theme);
        document.body.setAttribute("data-theme", theme);
        document.documentElement.classList.remove("theme-light", "theme-dark");
        document.body.classList.remove("theme-light", "theme-dark");
        document.documentElement.classList.add("theme-" + theme);
        document.body.classList.add("theme-" + theme);
        try {
          window.localStorage.setItem(storageKey, theme);
        } catch (err) {
          /* ignore */
        }
        var toggle = document.getElementById("theme-toggle");
        if (toggle) {
          toggle.setAttribute(
            "aria-label",
            theme === "dark"
              ? "Switch to light theme"
              : "Switch to dark theme"
          );
          toggle.setAttribute("data-theme", theme);
        }
        var icon = document.getElementById("theme-toggle-icon");
        if (icon) {
          icon.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
        }
      }
      applyTheme(current);
      window.cmeTheme = {
        toggle: function () {
          applyTheme(current === "dark" ? "light" : "dark");
        },
        set: function (theme) {
          applyTheme(theme === "dark" ? "dark" : "light");
        },
      };
      document.addEventListener("DOMContentLoaded", function () {
        var toggle = document.getElementById("theme-toggle");
        if (toggle) {
          toggle.addEventListener("click", function () {
            window.cmeTheme.toggle();
          });
        }
      });
    })();

    // Handle ingest response from Discover button
    window.handleIngestResponse = function (btn, evt) {
      if (btn.dataset) {
        btn.textContent = btn.dataset.originalText || 'Discover activities';
        btn.disabled = false;
      }
      try {
        var xhr = evt.detail && evt.detail.xhr;
        if (xhr) {
          var data = {};
          try {
            data = JSON.parse(xhr.responseText || '{}');
          } catch (err) {
            data = {};
          }
          if (typeof data.ingested !== 'undefined') {
            var params = new URLSearchParams(window.location.search);
            params.set('added', data.ingested || 0);
            if (typeof data.google_inserted !== 'undefined') {
              params.set('gcount', data.google_inserted || 0);
            }
            if (typeof data.ai_inserted !== 'undefined') {
              params.set('acount', data.ai_inserted || 0);
            }
            params.set('fallback', data.used_fallback ? '1' : '0');
            history.replaceState(null, '', '?' + params.toString());
            var banner = document.getElementById('ingest-banner');
            if (banner) {
              banner.innerHTML = '<div class="ingest-notice ingest-ok">Imported ' +
                (data.ingested || 0) + ' new activities ‚Äî Web: ' +
                (data.google_inserted || 0) + ', AI: ' +
                (data.ai_inserted || 0) +
                (data.used_fallback ? ' (fallback used)' : '') + '.</div>';
            }
            var planRoot = document.getElementById('plan-card');
            if (planRoot && window.htmx) {
              window.htmx.trigger(document.body || window, 'plan-refresh');
            }
            return;
          }
          if (data.error) {
            var banner = document.getElementById('ingest-banner');
            if (banner) {
              banner.innerHTML = '<div class="ingest-notice ingest-error">' + data.error + '</div>';
            }
            return;
          }
        }
      } catch (err) {
        console.error(err);
      }
    };

    // Handle re-enrich response
    window.handleReenrichResponse = function (btn, evt) {
      if (btn.dataset) {
        btn.textContent = btn.dataset.originalText || 'Enrich data';
        btn.disabled = false;
      }
      try {
        var xhr = evt.detail && evt.detail.xhr;
        if (xhr) {
          var data = {};
          try {
            data = JSON.parse(xhr.responseText || '{}');
          } catch (err) {
            data = {};
          }
          var banner = document.getElementById('ingest-banner');
          if (data.error) {
            if (banner) {
              banner.innerHTML = '<div class="ingest-notice ingest-error">' + data.error + '</div>';
            }
            return;
          }
          if (typeof data.updated !== 'undefined') {
            if (banner) {
              banner.innerHTML = '<div class="ingest-notice ingest-ok">Enriched ' +
                (data.updated || 0) + ' of ' + (data.checked || 0) + ' activities with pricing/eligibility data.</div>';
            }
            var planRoot = document.getElementById('plan-card');
            if (planRoot && window.htmx) {
              window.htmx.trigger(document.body || window, 'plan-refresh');
            }
          }
        }
      } catch (err) {
        console.error(err);
      }
    };

    // Chat Drawer Toggle
    document.addEventListener('DOMContentLoaded', function () {
      var drawer = document.getElementById('chat-drawer');
      var toggle = document.getElementById('chat-drawer-toggle');

      if (drawer && toggle) {
        // Create overlay element
        var overlay = document.createElement('div');
        overlay.className = 'chat-drawer-overlay';
        overlay.id = 'chat-drawer-overlay';
        document.body.appendChild(overlay);

        function openDrawer() {
          drawer.classList.add('open');
          overlay.classList.add('visible');
          document.body.classList.add('chat-open');
          document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
          drawer.classList.remove('open');
          overlay.classList.remove('visible');
          document.body.classList.remove('chat-open');
          document.body.style.overflow = '';
        }

        function toggleDrawer() {
          if (drawer.classList.contains('open')) {
            closeDrawer();
          } else {
            openDrawer();
          }
        }

        toggle.addEventListener('click', toggleDrawer);
        overlay.addEventListener('click', closeDrawer);

        // Close on Escape key
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && drawer.classList.contains('open')) {
            closeDrawer();
          }
        });

        // Expose functions globally for HTMX events
        window.cmeChatDrawer = {
          open: openDrawer,
          close: closeDrawer,
          toggle: toggleDrawer
        };
      }

      // Chat form: instant message display with typing indicator
      var chatForm = document.getElementById('chat-form');
      var chatInput = document.getElementById('chat-input-text');
      var chatWindow = document.getElementById('chat-window');
      var chatSendBtn = document.getElementById('chat-send-btn');

      if (chatForm && chatInput && chatWindow) {
        chatForm.addEventListener('submit', function (e) {
          e.preventDefault();
          var text = chatInput.value.trim();
          if (!text) return;

          // Disable input while processing
          chatInput.disabled = true;
          chatSendBtn.disabled = true;

          // Immediately display user message
          var userMsg = document.createElement('div');
          userMsg.className = 'chat-message chat-message-out user';
          userMsg.innerHTML = '<div class="chat-bubble user">' + escapeHtml(text) + '</div>';
          chatWindow.appendChild(userMsg);

          // Add typing indicator
          var typingIndicator = document.createElement('div');
          typingIndicator.className = 'chat-message chat-message-in';
          typingIndicator.id = 'typing-indicator';
          typingIndicator.innerHTML = `
            <div class="chat-avatar" aria-hidden="true">AI</div>
            <div class="chat-bubble assistant typing-indicator">
              <p><span class="dot"></span><span class="dot"></span><span class="dot"></span></p>
            </div>
          `;
          chatWindow.appendChild(typingIndicator);

          // Scroll to bottom
          chatWindow.scrollTop = chatWindow.scrollHeight;

          // Clear input
          chatInput.value = '';

          // Make async request
          var formData = new FormData();
          formData.append('text', text);

          fetch('/chat/send', {
            method: 'POST',
            body: formData
          })
            .then(function (response) {
              return response.text();
            })
            .then(function (html) {
              // Remove typing indicator
              var indicator = document.getElementById('typing-indicator');
              if (indicator) indicator.remove();

              // Append assistant response (the server returns the assistant message HTML)
              // But we need to filter out the user message since we already showed it
              var temp = document.createElement('div');
              temp.innerHTML = html;
              var messages = temp.querySelectorAll('.chat-message');
              messages.forEach(function (msg) {
                // Only append non-user messages (assistant/error)
                // Server uses 'chat-message-out' for user messages
                if (!msg.classList.contains('chat-message-out')) {
                  chatWindow.appendChild(msg);
                }
              });

              // Scroll to bottom
              chatWindow.scrollTop = chatWindow.scrollHeight;

              // Trigger plan refresh if needed
              if (window.htmx) {
                window.htmx.trigger(document.body, 'plan-refresh');
              }
            })
            .catch(function (err) {
              console.error('Chat error:', err);
              // Remove typing indicator
              var indicator = document.getElementById('typing-indicator');
              if (indicator) indicator.remove();

              // Show error message
              var errMsg = document.createElement('div');
              errMsg.className = 'chat-message error';
              errMsg.innerHTML = '<p>Something went wrong. Please try again.</p>';
              chatWindow.appendChild(errMsg);
              chatWindow.scrollTop = chatWindow.scrollHeight;
            })
            .finally(function () {
              // Re-enable input
              chatInput.disabled = false;
              chatSendBtn.disabled = false;
              chatInput.focus();
            });
        });
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    });
  </script>
</body>

</html>