{% extends "base.html" %}
{% block content %}
{% set current_mode = (plan_mode | default(request.query_params.get('mode', 'balanced')))|lower %}
  <h1>CME/MOC Planner (ABPN POC)</h1>

  {% if not user %}
    <section class="card">
      <h2>Setup</h2>
      <form method="post" action="/setup">
        <label>Target credits <input name="target_credits" type="number" step="0.5" value="10" required></label>
        <label>Budget (USD) <input name="budget_usd" type="number" step="1" value="300" required></label>
        <label>Days off allowed <input name="days_off" type="number" value="0" required></label>
        <label>Allow live events? <input name="allow_live" type="checkbox"></label>
        <label>Prefer live events? <input name="prefer_live" type="checkbox"></label>
        <label>Name <input name="name" value="Doctor"></label>
        <label>Specialty <input name="specialty" value="Psychiatry"></label>
        <label>City <input name="city" placeholder="(optional)"></label>
        <label>Residency completion year <input name="residency_completion_year" type="number" min="1980" max="2100" placeholder="e.g., 2021"></label>
        <label>Professional stage
          <select name="professional_stage">
            <option value="" selected>Select…</option>
            <option value="early_career">Early career (&lt;4 years post-residency)</option>
            <option value="standard">Established practitioner</option>
            <option value="resident">Resident / Fellow</option>
          </select>
        </label>
        <label>Memberships (comma separated)
          <input name="memberships" placeholder="American Psychiatric Association, State Society">
        </label>
        <button type="submit">Save setup</button>
      </form>
    </section>
  {% else %}
    <section class="stats">
      <div class="badge">Remaining: {{ '%.1f' % user.remaining_credits }} credits</div>
      <div>
        Budget: ${{ '%.0f' % user.budget_usd }} | Days off: {{ user.days_off }} | Live OK: {{ 'Yes' if user.allow_live else 'No' }} | Prefer live: {{ 'Yes' if user.prefer_live else 'No' }}
        {% if user.professional_stage %} | Stage: {{ user.professional_stage.replace('_', ' ')|title }}{% endif %}
        {% if user.residency_completion_year %} | Residency: {{ user.residency_completion_year }}{% endif %}
        {% if user.memberships %} | Memberships: {{ (user.memberships or [])|join(', ') }}{% endif %}
        {% if is_dev %}
          <span style="margin-left:8px;">
            <a href="/ingest?debug=1" target="_blank">debug ingest</a>
          </span>
        {% endif %}
      </div>
    </section>

    {% if policy_status and policy_status|length > 0 %}
      <div class="policy-banner">
        <span>Policy active:</span>
        {% for p in policy_status %}
          <span class="badge policy">
            {{ p.mode|capitalize }}{% if p.hours_left is not none %} (expires in {{ p.hours_left }}h){% endif %}
          </span>
        {% endfor %}
        <form hx-post="/policy/clear" hx-target="#chat-window" hx-swap="beforeend" hx-on::after-request="const el=document.getElementById('chat-window'); if (el) { el.scrollTop = el.scrollHeight; }" style="display:inline; margin-left:8px;">
          <button type="submit" class="linklike">Clear</button>
        </form>
      </div>
    {% endif %}

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Assistant</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <a href="/preferences" class="button">Edit Preferences</a>
        </div>
      </div>
      <div
        id="chat-window"
        class="chat-window"
        hx-get="/chat"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-on::after-settle="this.scrollTop = this.scrollHeight"
      >
        <!-- Chat messages load here -->
      </div>
      <form
        class="chat-input"
        hx-post="/chat/send"
        hx-target="#chat-window"
        hx-swap="beforeend"
        hx-on::after-request="this.reset(); const el = document.getElementById('chat-window'); if (el) { el.scrollTop = el.scrollHeight; }"
      >
        <input name="text" placeholder="Ask about this plan, request changes, or say 'explain why'…" required />
        <button type="submit">Send</button>
      </form>
    </section>

    {% set added = request.query_params.get('added') %}
    {% set gcount = request.query_params.get('gcount') %}
    {% set acount = request.query_params.get('acount') %}
    {% set fallback = request.query_params.get('fallback') %}
    {% set error = request.query_params.get('error') %}
    <div id="ingest-banner">
      {% if added %}
        <div class="card" style="background:#f0fff4;border-left:4px solid #34d399;padding:8px 12px;margin:8px 0;">
          Imported {{ added }} new activities{% if gcount or acount %} — Web: {{ gcount or 0 }}, AI: {{ acount or 0 }}{% endif %}{% if fallback == '1' %} (fallback used){% endif %}.
        </div>
      {% elif error %}
        <div class="card" style="background:#fff7f7;border-left:4px solid #f87171;padding:8px 12px;margin:8px 0;">{{ error }}</div>
      {% endif %}
    </div>

    <div id="plan-card" data-plan-mode="{{ current_mode }}"
         hx-get="/fragment/plan?mode={{ current_mode }}"
         hx-trigger="plan-refresh from:body"
         hx-target="this"
         hx-swap="innerHTML"
         hx-vals='{"refresh":"1"}'>
      {% include '_plan.html' %}
    </div>

    {% if validation %}
      <section class="card">
        <h2>Requirements ({{ validation.meta.board }} — {{ validation.meta.specialty }})</h2>
        <div class="meta">Version: {{ validation.meta.version }}</div>
        <div class="meta">Totals: {{ '%.1f' % validation.summary.earned_total }} / {{ validation.summary.target_total }} (remaining {{ '%.1f' % validation.summary.remaining_total }})</div>
        <ul class="checks">
          {% for chk in validation.checks %}
            <li>
              {% if chk.status == 'ok' %}✅{% elif chk.status == 'warn' %}⚠️{% else %}❌{% endif %}
              <strong>{{ chk.label }}</strong> — {{ chk.detail }}
            </li>
          {% endfor %}
        </ul>
        <div class="meta">Sources:
          {% for s in validation.meta.sources %}
            <a href="{{ s }}" target="_blank" rel="noopener">{{ s }}</a>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </div>
        {% if validation_full %}
          <div class="meta" style="margin-top:12px;">Comprehensive CC Checklist</div>
          <ul class="checks">
            {% for key in ['cme', 'sa_cme', 'pip', 'patient_safety'] %}
              {% set pillar = validation_full.pillars.get(key) %}
              {% if pillar %}
                <li>
                  {% if pillar.status == 'ok' %}✅{% elif pillar.status == 'warn' %}⚠️{% else %}❌{% endif %}
                  <strong>{{ pillar.label }}</strong> — {{ pillar.detail }}
                </li>
              {% endif %}
            {% endfor %}
          </ul>
          {% if validation_full.gaps %}
            <div class="meta">Gaps: {{ validation_full.gaps | join(', ') }}</div>
          {% endif %}
        {% endif %}
      </section>
    {% endif %}

    <section class="card">
      <h2>Activity Log</h2>
      <ul>
        {% for c in claims or [] %}
          <li>{{ c.date }} — {{ '%.1f' % c.credits }} cr — {{ c.topic or 'general' }} — {{ c.source_text }}</li>
        {% endfor %}
      </ul>
    </section>

  {% endif %}
{% endblock %}
