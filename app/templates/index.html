{% extends "base.html" %}
{% block content %}
  {% set current_mode = (plan_mode | default(request.query_params.get('plan_mode', 'variety')))|lower %}
  <h1>CME/MOC Planner (ABPN POC)</h1>

  {% if not user %}
    <section class="card">
      <h2>Setup</h2>
      <form method="post" action="/setup">
        <label>Target credits <input name="target_credits" type="number" step="0.5" value="10" required></label>
        <label>Budget (USD) <input name="budget_usd" type="number" step="1" value="300" required></label>
        <label>Days off allowed <input name="days_off" type="number" value="0" required></label>
        <label>Allow live events? <input name="allow_live" type="checkbox"></label>
        <label>Prefer live events? <input name="prefer_live" type="checkbox"></label>
        <label>Name <input name="name" value="Doctor"></label>
        <label>Specialty <input name="specialty" value="Psychiatry"></label>
        <label>City <input name="city" placeholder="(optional)"></label>
        <button type="submit">Save setup</button>
      </form>
    </section>
  {% else %}
    <section class="stats">
      <div class="badge">Remaining: {{ '%.1f' % user.remaining_credits }} credits</div>
      <div>
        Budget: ${{ '%.0f' % user.budget_usd }} | Days off: {{ user.days_off }} | Live OK: {{ 'Yes' if user.allow_live else 'No' }} | Prefer live: {{ 'Yes' if user.prefer_live else 'No' }}
        {% if is_dev %}
          <span style="margin-left:8px;">
            <a href="/ingest?debug=1" target="_blank">debug ingest</a>
          </span>
        {% endif %}
      </div>
    </section>

    {% if policy_status and policy_status|length > 0 %}
      <div class="policy-banner">
        <span>Policy active:</span>
        {% for p in policy_status %}
          <span class="badge policy">
            {{ p.mode|capitalize }}{% if p.hours_left is not none %} (expires in {{ p.hours_left }}h){% endif %}
          </span>
        {% endfor %}
        <form hx-post="/policy/clear" hx-target="#chat-window" hx-swap="beforeend" hx-on::after-request="const el=document.getElementById('chat-window'); if (el) { el.scrollTop = el.scrollHeight; }" style="display:inline; margin-left:8px;">
          <button type="submit" class="linklike">Clear</button>
        </form>
      </div>
    {% endif %}

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Assistant</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <a href="/preferences" class="button">Edit Preferences</a>
        </div>
      </div>
      <div
        id="chat-window"
        class="chat-window"
        hx-get="/chat"
        hx-trigger="load"
        hx-swap="innerHTML"
        hx-on::after-settle="this.scrollTop = this.scrollHeight"
      >
        <!-- Chat messages load here -->
      </div>
      <form
        class="chat-input"
        hx-post="/chat/send"
        hx-target="#chat-window"
        hx-swap="beforeend"
        hx-on::after-request="this.reset(); const el = document.getElementById('chat-window'); if (el) { el.scrollTop = el.scrollHeight; }"
      >
        <input name="text" placeholder="Ask about this plan, request changes, or say 'explain why'…" required />
        <button type="submit">Send</button>
      </form>
    </section>

    {% set added = request.query_params.get('added') %}
    {% set gcount = request.query_params.get('gcount') %}
    {% set acount = request.query_params.get('acount') %}
    {% set fallback = request.query_params.get('fallback') %}
    {% set error = request.query_params.get('error') %}
    {% if added %}
      <div class="card" style="background:#f0fff4;border-left:4px solid #34d399;padding:8px 12px;margin:8px 0;">
        Imported {{ added }} new activities{% if gcount or acount %} — Google: {{ gcount or 0 }}, AI: {{ acount or 0 }}{% endif %}{% if fallback == '1' %} (fallback used){% endif %}.
      </div>
    {% elif error %}
      <div class="card" style="background:#fff7f7;border-left:4px solid #f87171;padding:8px 12px;margin:8px 0;">{{ error }}</div>
    {% endif %}

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Recommended Plan</h2>
        <button
          hx-post="/ingest"
          hx-swap="none"
          hx-on::after-request="window.location.reload()"
          class="button"
          type="button"
        >Discover</button>
      </div>
      <div class="tabs">
        <a href="/?plan_mode=cheapest" class="btn{% if current_mode == 'cheapest' %} active{% endif %}">Cheapest</a>
        <a href="/?plan_mode=variety" class="btn{% if current_mode == 'variety' %} active{% endif %}">Variety</a>
      </div>
      {% if current_mode == 'cheapest' %}
        <p class="meta" style="margin-top:-4px;">Optimized for lowest cost per credit; may choose a single subscription.</p>
      {% elif current_mode == 'variety' %}
        <p class="meta" style="margin-top:-4px;">Optimized for balanced mix; avoids letting one item dominate.</p>
      {% endif %}
      {% if plan and plan|length > 0 %}
        <ul class="plan">
          {% for p in plan %}
            <li>
              <div class="title">
                {% if p.url %}
                  <a href="{{ p.url }}" target="_blank" rel="noopener noreferrer">{{ p.title }}</a>
                {% else %}
                  {{ p.title }}
                {% endif %}
              </div>
              <div class="meta">
                {{ p.provider }} • {{ p.modality }}{% if p.city %} • {{ p.city }}{% endif %}
                {% if p.source %}
                  <span class="badge" style="margin-left:8px; background:#eef;">{{ p.source|capitalize }}</span>
                {% endif %}
                {% if p.eligibility_status == 'eligible' %}
                  <span class="badge eligibility ok" title="{{ p.eligibility_text or 'Eligible for you' }}">✅ Eligible</span>
                {% elif p.eligibility_status == 'uncertain' %}
                  <span class="badge eligibility warn" title="{{ p.eligibility_text or 'Eligibility needs manual check' }}">⚠️ Check eligibility</span>
                {% elif p.eligibility_status == 'ineligible' %}
                  <span class="badge eligibility no" title="{{ p.eligibility_text or 'Not eligible based on current info' }}">❌ Not eligible</span>
                {% endif %}
              </div>
              <div class="meta">{{ '%.1f' % p.credits }} cr • ${{ '%.0f' % p.cost }}</div>
              {% if p.summary %}
                <div class="meta">{{ p.summary }}</div>
              {% endif %}
              <form method="post" action="/plan/remove" style="margin-top:6px;">
                <input type="hidden" name="title" value="{{ p.title }}" />
                <button type="submit" class="linklike" title="Remove this from plan">Remove</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No plan yet or all requirements met.</p>
      {% endif %}
    </section>

    {% if validation %}
      <section class="card">
        <h2>Requirements ({{ validation.meta.board }} — {{ validation.meta.specialty }})</h2>
        <div class="meta">Version: {{ validation.meta.version }}</div>
        <div class="meta">Totals: {{ '%.1f' % validation.summary.earned_total }} / {{ validation.summary.target_total }} (remaining {{ '%.1f' % validation.summary.remaining_total }})</div>
        <ul class="checks">
          {% for chk in validation.checks %}
            <li>
              {% if chk.status == 'ok' %}✅{% elif chk.status == 'warn' %}⚠️{% else %}❌{% endif %}
              <strong>{{ chk.label }}</strong> — {{ chk.detail }}
            </li>
          {% endfor %}
        </ul>
        <div class="meta">Sources:
          {% for s in validation.meta.sources %}
            <a href="{{ s }}" target="_blank" rel="noopener">{{ s }}</a>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <section class="card">
      <h2>Activity Log</h2>
      <ul>
        {% for c in claims or [] %}
          <li>{{ c.date }} — {{ '%.1f' % c.credits }} cr — {{ c.topic or 'general' }} — {{ c.source_text }}</li>
        {% endfor %}
      </ul>
    </section>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('ingestForm');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button[type="submit"]');
          const original = btn ? btn.textContent : null;
          if (btn) { btn.disabled = true; btn.textContent = 'Discovering...'; }
          try {
            const resp = await fetch('/ingest', { method: 'POST' });
            let data = {};
            try { data = await resp.json(); } catch {}
            if (resp.ok && typeof data.ingested !== 'undefined') {
              const fb = data.used_fallback ? '1' : '0';
              const added = encodeURIComponent(data.ingested || 0);
              const gcount = encodeURIComponent(data.google_inserted || 0);
              const acount = encodeURIComponent(data.ai_inserted || 0);
              window.location.href = `/?added=${added}&fallback=${fb}&gcount=${gcount}&acount=${acount}`;
              return;
            }
            window.location.href = '/?error=ingest_failed';
          } catch (err) {
            window.location.href = '/?error=ingest_failed';
          } finally {
            if (btn) { btn.disabled = false; if (original) btn.textContent = original; }
          }
        });
      });
    </script>
  {% endif %}
{% endblock %}
