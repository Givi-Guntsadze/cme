{% extends "base.html" %}
{% block content %}
  <h1>CME/MOC Planner (ABPN POC)</h1>

  {% if not user %}
    <section class="card">
      <h2>Setup</h2>
      <form method="post" action="/setup">
        <label>Target credits <input name="target_credits" type="number" step="0.5" value="10" required></label>
        <label>Budget (USD) <input name="budget_usd" type="number" step="1" value="300" required></label>
        <label>Days off allowed <input name="days_off" type="number" value="0" required></label>
        <label>Allow live events? <input name="allow_live" type="checkbox"></label>
        <label>Name <input name="name" value="Doctor"></label>
        <label>Specialty <input name="specialty" value="Psychiatry"></label>
        <label>City <input name="city" placeholder="(optional)"></label>
        <button type="submit">Save setup</button>
      </form>
    </section>
  {% else %}
    <section class="stats">
      <div class="badge">Remaining: {{ '%.1f' % user.remaining_credits }} credits</div>
      <div>Budget: ${{ '%.0f' % user.budget_usd }} | Days off: {{ user.days_off }} | Live OK: {{ 'Yes' if user.allow_live else 'No' }}</div>
    </section>

    <section class="card">
      <h2>Recommended Plan</h2>
      {% if plan and plan|length > 0 %}
        <ul class="plan">
          {% for p in plan %}
            <li>
              <div class="title">{{ p.title }}</div>
              <div class="meta">{{ p.provider }} • {{ p.modality }}{% if p.city %} • {{ p.city }}{% endif %}</div>
              <div class="meta">{{ '%.1f' % p.credits }} cr • ${{ '%.0f' % p.cost }}</div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No plan yet or all requirements met.</p>
      {% endif %}
    </section>

    <section class="card">
      <h2>Log a quick update</h2>
      <form method="post" action="/message">
        <input name="text" placeholder="e.g., Got 1 credit on Doximity for ethics" required />
        <button type="submit">Add</button>
      </form>
    </section>

    <section class="card">
      <h2>Activity Log</h2>
      <ul>
        {% for c in claims or [] %}
          <li>{{ c.date }} — {{ '%.1f' % c.credits }} cr — {{ c.topic or 'general' }} — {{ c.source_text }}</li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endblock %}