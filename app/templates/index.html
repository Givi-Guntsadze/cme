{% extends "base.html" %}
{% block content %}
  <h1>CME/MOC Planner (ABPN POC)</h1>

  {% if chat_only %}
    <section class="card">
      <h2>Chat</h2>
      {% if assistant_messages %}
        <ul>
          {% for m in assistant_messages %}
            <li style="white-space:pre-wrap;">
              <span class="badge" style="margin-right:6px; background:#eee;">{{ m.role or 'assistant' }}</span>
              {{ m.content }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No messages yet.</p>
      {% endif %}
      <form method="post" action="/chat/send" style="margin-top:8px;display:flex;gap:8px;">
        <input name="text" placeholder="Ask about your plan or set preferences..." style="flex:1" required />
        <button type="submit">Send</button>
      </form>
      <div style="margin-top:8px;"><a href="/">Back to Plan</a></div>
    </section>
  {% elif not user %}
    <section class="card">
      <h2>Setup</h2>
      <form method="post" action="/setup">
        <label>Target credits <input name="target_credits" type="number" step="0.5" value="10" required></label>
        <label>Budget (USD) <input name="budget_usd" type="number" step="1" value="300" required></label>
        <label>Days off allowed <input name="days_off" type="number" value="0" required></label>
        <label>Allow live events? <input name="allow_live" type="checkbox"></label>
        <label>Prefer live events? <input name="prefer_live" type="checkbox"></label>
        <label>Name <input name="name" value="Doctor"></label>
        <label>Specialty <input name="specialty" value="Psychiatry"></label>
        <label>City <input name="city" placeholder="(optional)"></label>
        <button type="submit">Save setup</button>
      </form>
    </section>
  {% else %}
    <section class="stats">
      <div class="badge">Remaining: {{ '%.1f' % user.remaining_credits }} credits</div>
      <div>
        Budget: ${{ '%.0f' % user.budget_usd }} | Days off: {{ user.days_off }} | Live OK: {{ 'Yes' if user.allow_live else 'No' }} | Prefer live: {{ 'Yes' if user.prefer_live else 'No' }}
        {% if is_dev %}
          <span style="margin-left:8px;">
            <a href="/ingest?debug=1" target="_blank">debug ingest</a>
          </span>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Assistant</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <a href="/chat" class="button">Open Chat</a>
          <a href="/preferences" class="button">Edit Preferences</a>
          <form method="post" action="/assist">
            <button type="submit">Explain and ask preferences</button>
          </form>
        </div>
      </div>
      {% if assistant_messages %}
        <ul>
          {% for m in assistant_messages %}
            <li style="white-space:pre-wrap;">{{ m.content }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No assistant messages yet.</p>
      {% endif %}
      <form method="post" action="/assist/command" style="margin-top:8px;display:flex;gap:8px;">
        <input name="command" placeholder="e.g., Avoid subscriptions; diversify providers; focus on ethics" style="flex:1" required />
        <button type="submit">Apply command</button>
      </form>
    </section>

    {% set added = request.query_params.get('added') %}
    {% set gcount = request.query_params.get('gcount') %}
    {% set acount = request.query_params.get('acount') %}
    {% set fallback = request.query_params.get('fallback') %}
    {% set error = request.query_params.get('error') %}
    {% if added %}
      <div class="card" style="background:#f0fff4;border-left:4px solid #34d399;padding:8px 12px;margin:8px 0;">
        Imported {{ added }} new activities{% if gcount or acount %} — Google: {{ gcount or 0 }}, AI: {{ acount or 0 }}{% endif %}{% if fallback == '1' %} (fallback used){% endif %}.
      </div>
    {% elif error %}
      <div class="card" style="background:#fff7f7;border-left:4px solid #f87171;padding:8px 12px;margin:8px 0;">{{ error }}</div>
    {% endif %}

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">Recommended Plan</h2>
        <form id="ingestForm" method="post" action="/ingest">
          <button type="submit">Discover</button>
        </form>
      </div>
      {% if plan and plan|length > 0 %}
        <ul class="plan">
          {% for p in plan %}
            <li>
              <div class="title">
                {% if p.url %}
                  <a href="{{ p.url }}" target="_blank" rel="noopener noreferrer">{{ p.title }}</a>
                {% else %}
                  {{ p.title }}
                {% endif %}
              </div>
              <div class="meta">
                {{ p.provider }} • {{ p.modality }}{% if p.city %} • {{ p.city }}{% endif %}
                {% if p.source %}
                  <span class="badge" style="margin-left:8px; background:#eef;">{{ p.source|capitalize }}</span>
                {% endif %}
              </div>
              <div class="meta">{{ '%.1f' % p.credits }} cr • ${{ '%.0f' % p.cost }}</div>
              {% if p.summary %}
                <div class="meta">{{ p.summary }}</div>
              {% endif %}
              <form method="post" action="/plan/remove" style="margin-top:6px;">
                <input type="hidden" name="title" value="{{ p.title }}" />
                <button type="submit" class="linklike" title="Remove this from plan">Remove</button>
              </form>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No plan yet or all requirements met.</p>
      {% endif %}
    </section>

    <section class="card">
      <h2>Log a quick update</h2>
      <form method="post" action="/message">
        <input name="text" placeholder="e.g., Got 1 credit on Doximity for ethics" required />
        <button type="submit">Add</button>
      </form>
    </section>

    <section class="card">
      <h2>Activity Log</h2>
      <ul>
        {% for c in claims or [] %}
          <li>{{ c.date }} — {{ '%.1f' % c.credits }} cr — {{ c.topic or 'general' }} — {{ c.source_text }}</li>
        {% endfor %}
      </ul>
    </section>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('ingestForm');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button[type="submit"]');
          const original = btn ? btn.textContent : null;
          if (btn) { btn.disabled = true; btn.textContent = 'Discovering...'; }
          try {
            const resp = await fetch('/ingest', { method: 'POST' });
            let data = {};
            try { data = await resp.json(); } catch {}
            if (resp.ok && typeof data.ingested !== 'undefined') {
              const fb = data.used_fallback ? '1' : '0';
              const added = encodeURIComponent(data.ingested || 0);
              const gcount = encodeURIComponent(data.google_inserted || 0);
              const acount = encodeURIComponent(data.ai_inserted || 0);
              window.location.href = `/?added=${added}&fallback=${fb}&gcount=${gcount}&acount=${acount}`;
              return;
            }
            window.location.href = '/?error=ingest_failed';
          } catch (err) {
            window.location.href = '/?error=ingest_failed';
          } finally {
            if (btn) { btn.disabled = false; if (original) btn.textContent = original; }
          }
        });
      });
    </script>
  {% endif %}
{% endblock %}